<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowGo Slideshow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; color: #fff; font-family: Inter, sans-serif; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        body.fullscreen-active { cursor: none; }
        #slideshow-container { position: relative; width: 100%; height: 100%; overflow: hidden; background-color: #000; } /* Ensure background is black */

        /* Common styles for media elements */
        #slideshow-image, #slideshow-video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; /* Start hidden */
            transition: opacity 1s ease-in-out; /* Fade transition */
            background-color: transparent; /* Allow container background to show */
            transform-origin: center center;
            display: none; /* Use JS to control display block/none */
        }
        /* Active state (controlled by JS) */
        #slideshow-image.active, #slideshow-video.active {
            opacity: 1;
            display: block;
        }
        /* Ken Burns specific to image */
        #slideshow-image.kenburns-active {
            transition: opacity 1s ease-in-out, transform var(--kb-duration) linear;
        }

        /* Widget container and individual widgets */
        #widget-container { position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: flex-end; z-index: 10; pointer-events: none; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        .widget { background-color: rgba(0, 0, 0, 0.6); padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 1.1rem; margin: 0 10px; }
        #time-widget {}
        #weather-widget { text-align: right; }
        #weather-widget img { display: inline-block; height: 1.5em; width: 1.5em; vertical-align: middle; margin-left: 0.25rem; }
        #watermark { position: absolute; z-index: 20; background-color: rgba(0, 0, 0, 0.6); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.9rem; pointer-events: auto; }
        #status-message-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; text-align: center; z-index: 5; font-size: 1.25rem; }

        /* RSS Ticker */
        #rss-ticker-container { position: absolute; bottom: 80px; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.6); padding: 0.5rem 0; overflow: hidden; white-space: nowrap; z-index: 11; box-sizing: border-box; pointer-events: none; }
        #rss-ticker-content { display: inline-block; padding-left: 100%; animation: ticker-scroll var(--rss-scroll-duration, 80s) linear infinite; font-size: 1rem; color: #e5e7eb; }
        #rss-ticker-content span.rss-item { margin: 0 1.5rem; }
        #rss-ticker-content span.rss-separator { color: #6b7280; margin: 0 0.5rem; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Watermark Positions */
        .top-left { top: 10px; left: 10px; } .top-right { top: 10px; right: 10px; } .bottom-left { bottom: 10px; left: 10px; } .bottom-right { bottom: 10px; right: 10px; }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-hidden">

    <div id="slideshow-container" class="relative w-full h-screen overflow-hidden">
        <div id="status-message-display">
            {# Updated variable name #}
            {% if not media_items %}
                <p>No valid media found for slideshow.</p>
            {% endif %}
        </div>
        {# Image Element #}
        <img id="slideshow-image" src="" alt="Slideshow Image" class="absolute top-0 left-0 w-full h-full">

        {# Video Element (NEW) #}
        <video id="slideshow-video" src="" class="absolute top-0 left-0 w-full h-full">
            Your browser does not support the video tag.
        </video>
    </div>

    {# --- Widgets (No changes needed) --- #}
    {% if config.watermark.enabled and config.watermark.text %}
    <div id="watermark" class="widget {{ config.watermark.position | default('bottom-right') }}">
        {{ config.watermark.text }}
    </div>
    {% endif %}

    <div id="widget-container">
        {% if config.widgets.time.enabled %}
        <div id="time-widget" class="widget">
             <span id="time-display">--:--:-- --</span>
        </div>
        {% else %} <div></div> {% endif %}

        {% if config.widgets.weather.enabled and weather %}
            <div id="weather-widget" class="widget">
                <span id="weather-location">{{ weather.name }}</span>:
                <span id="weather-temp">{{ weather.main.temp | round | int }}&deg;F</span>,
                <span id="weather-desc">{{ weather.weather[0].description | title }}</span>
                {% if weather.weather[0].icon %}
                <img src="https://openweathermap.org/img/wn/{{ weather.weather[0].icon }}.png" alt="">
                {% endif %}
            </div>
        {% elif not config.widgets.time.enabled %} <div></div> {% endif %}
    </div>

    {% if config.widgets.rss.enabled and rss_headlines %}
    <div id="rss-ticker-container">
        <div id="rss-ticker-content">
            {% for _ in range(2) %} {# Duplicate content for seamless scroll #}
                {% for item in rss_headlines %}
                    <span class="rss-item">{{ item.title }}</span>
                    <span class="rss-separator"> // </span>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {# --- End Widgets --- #}

    <script>
        // --- Initialize Slideshow Data ---
        let slideshowData = null;
        try {
            // Pass data directly from Flask template
            slideshowData = {
                // *** Use media_items list (contains dicts with 'filename' and 'type') ***
                mediaItems: {{ media_items | tojson | safe }},
                config: {{ config | tojson | safe }}, // Contains all nested settings
                initialTimestamp: {% if initial_config_timestamp is not none %}{{ initial_config_timestamp }}{% else %}null{% endif %},
                // *** Rename to mediaBaseUrl ***
                mediaBaseUrl: "{{ url_for('main_bp.serve_uploaded_media', filename='') }}",
                weatherError: {{ weather_error | tojson | safe }},
                rssError: {{ rss_error | tojson | safe }}
            };

            if (slideshowData.weatherError) { console.error("Weather Widget Error:", slideshowData.weatherError); }
            if (slideshowData.rssError) { console.error("RSS Widget Error:", slideshowData.rssError); }

            // --- Data Restructuring/Defaults (Simplified as config is now passed fully structured) ---
            // Access nested config directly, e.g., slideshowData.config.slideshow.duration_seconds
            // Ensure nested objects exist for safety before accessing properties in JS if needed
            slideshowData.config = slideshowData.config || {};
            slideshowData.config.slideshow = slideshowData.config.slideshow || {};
            slideshowData.config.watermark = slideshowData.config.watermark || {};
            slideshowData.config.widgets = slideshowData.config.widgets || {};
            slideshowData.config.widgets.time = slideshowData.config.widgets.time || {};
            slideshowData.config.widgets.weather = slideshowData.config.widgets.weather || {};
            slideshowData.config.widgets.rss = slideshowData.config.widgets.rss || {};
            slideshowData.config.burn_in_prevention = slideshowData.config.burn_in_prevention || {};

            console.log("Slideshow Data Constructed Successfully:", slideshowData);

            // Check if media list is empty and update status message
             if (!slideshowData.mediaItems || slideshowData.mediaItems.length === 0) {
                 const statusDisplay = document.getElementById('status-message-display');
                 if (statusDisplay && !statusDisplay.querySelector('p')) {
                      statusDisplay.innerHTML = '<p>No valid media found for slideshow.</p>';
                 }
             }

        } catch (error) {
            console.error("Error initializing slideshow data:", error);
            const statusDisplay = document.getElementById('status-message-display');
            if (statusDisplay) {
                statusDisplay.innerHTML = '<p style="color: red;">Error loading slideshow data. Please check console.</p>';
            }
            slideshowData = null; // Ensure it's null on error
        }
    </script>

    {# Load slideshow.js AFTER slideshowData is defined #}
    <script src="{{ url_for('static', filename='js/slideshow.js') }}"></script>

</body>
</html>
